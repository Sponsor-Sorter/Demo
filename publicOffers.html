<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Create Public Offer - Sponsor Sorter">
  <title>Post Public Offer | Sponsor Sorter</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>

<header class="navbar1">
  <section class="navbar">
    <div class="navii">
      <h5><header>Sponsor Sorter</header></h5>
      <div>
        <background-img class="navimg" src="navimg.png" alt="">
        <nav>
          <li><a href="index.html">Home</a></li>
          <li><a href="finder.html">Finder</a></li>
        </nav>
        <nav>
          <li class="navr" id="auth-link"><a href="./dashboardsponsor.html">Dashboard</a></li>
          <li><a href="login.html">Logout</a></li>
        </nav>
      </div>
    </div>
  </section>
</header>

<section class="userprofile">
  <fieldset>
    <legend>Your Sponsor Profile</legend>
    <div class="profile-header">
      <div class="profile-picture">
        <img id="sponsor-profile-pic" onerror="this.src='logos.png';" alt="Profile Picture" class="profile-img">
        <p>Account Type: <span id="account-type">Sponsor</span></p>
        <div id="sponsor-overall-rating" style="margin-top: 10px;">
          <strong>Overall Rating:</strong> <span id="sponsor-average-stars">☆☆☆☆☆</span>
        </div>
      </div>
      <div class="profile-info">
        <p>Email: <span id="sponsor-email">[Email]</span></p>
        <p>Company: <span id="company">[Company]</span></p>
        <p>Location: <span id="sponsor-location">[Location]</span></p>
      </div>
    </div>
    <div class="help-block" id="profile-help-block" style="margin-top:10px;margin-bottom:8px;">
      <em>
        <strong>Profile Information:</strong><br>
        This section displays your sponsor account details as seen by sponsees on public offers. Please keep your info up to date in your account settings for trust and visibility.
      </em>
    </div>
  </fieldset>
</section>

<form id="offerForm" enctype="multipart/form-data">
  <section>
    <fieldset>
      <legend>Offer Details</legend>
      <div class="help-block" id="offer-help-block" style="margin-bottom:12px;">
        <em>
          <strong>Offer Creation Help:</strong><br>
          Fill out this form to create a new public sponsorship offer. You can use the presets to autofill common offers, or enter your own details. Make sure to include a clear title, description, and set relevant requirements. Fields marked <b>required</b> must be filled in.
        </em>
      </div>
      <label for="preset">Offer Preset:</label>
      <select id="preset" name="preset">
        <option value="">-- Select a Preset --</option>
        <option value="shoutout">Instagram Shoutout</option>
        <option value="youtube_review">YouTube Product Review</option>
        <option value="ongoing_monthly">Ongoing Monthly Sponsorship</option>
        <option value="story_mention">Instagram Story Mention</option>
        <option value="event">Event Sponsorship</option>
      </select>
      <button type="button" id="applyPresetBtn" style="margin-left:8px;">Apply Preset</button>
      <br><br>

      <label for="offerTitle">Offer Title / Campaign Name:</label>
      <input type="text" id="offerTitle" name="offerTitle" required><br><br>
      <label for="offerDescription">Offer Description:</label><br>
      <textarea id="offerDescription" name="offerDescription" rows="4" cols="50" required></textarea><br><br>

      <div class="form-row">
        <div class="form-group">
          <label for="price">Offer Amount (USD):</label>
          <input type="number" id="price" name="price" step="10" min="0" required>
        </div>
        <div class="form-group">
          <label for="payment">Payment:</label>
          <select id="payment" name="payment" required>
            <option value="">--Select--</option>
            <option value="weekly">Weekly</option>
            <option value="fortnightly">Fortnightly</option>
            <option value="monthly">Monthly</option>
            <option value="full_on_completion">FULL - On Completion</option>
          </select>
        </div>
      </div><br>

      <label for="jobType">Type of Job:</label>
      <select id="jobType" name="jobType" required>
        <option value="">--Select Type--</option>
        <option value="Shoutout">Shoutout</option>
        <option value="Product Placement">Product Placement</option>
        <option value="Dedicated Video">Dedicated Video</option>
        <option value="Story Mention">Story Mention</option>
        <option value="Event Sponsorship">Event Sponsorship</option>
        <option value="Ongoing Deal">Ongoing Deal</option>
      </select><br><br>

      <label for="deliverableType">Deliverable Type:</label>
      <select id="deliverableType" name="deliverableType" required>
        <option value="">--Select Deliverable--</option>
        <option value="Include in next video">Include in Next Video</option>
        <option value="Standalone Post">Standalone Post</option>
        <option value="Story Mention">Story Mention</option>
        <option value="Product Review">Product Review</option>
        <option value="Custom Content">Custom Content</option>
      </select><br><br>

      <label for="instructions">Instructions:</label><br>
      <textarea id="instructions" name="instructions" rows="4" cols="50"></textarea><br><br>

      <label for="sponsorshipDuration">Sponsorship Duration:</label>
      <select id="sponsorshipDuration" name="sponsorshipDuration" required>
        <option value="">--Select Duration--</option>
        <option value="One Off">One-off</option>
        <option value="1 Month">1 Month</option>
        <option value="3 Months">3 Months</option>
        <option value="6 Months">6 Months</option>
        <option value="1 Year">1 Year</option>
      </select><br><br>

      <label for="deadline">Deadline (Date by which job should be completed):</label>
      <input type="date" id="deadline" name="deadline" required><br><br>

      <!-- NEW FIELDS -->
      <label for="maxApplicants">Max Applicants:</label>
      <input type="number" id="maxApplicants" name="maxApplicants" min="1" placeholder="E.g. 100"><br><br>

      <label for="minFollowers">Min Followers Required:</label>
      <input type="number" id="minFollowers" name="minFollowers" min="0" placeholder="E.g. 5000"><br><br>

      <label for="audienceCountry">Audience Country (primary):</label>
      <input type="text" id="audienceCountry" name="audienceCountry" maxlength="80" placeholder="E.g. Australia"><br><br>
      <!-- END NEW FIELDS -->

      <label>Offer Platforms:</label>
      <div id="platformCheckboxes" style="margin-bottom:12px;">
        <label><input type="checkbox" name="offerPlatforms" value="instagram">
          <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/95/Instagram_logo_2022.svg/1200px-Instagram_logo_2022.svg.png" alt="Instagram" title="Instagram" style="width:22px;vertical-align:middle;margin-right:3px;">
          Instagram
        </label>
        <label><input type="checkbox" name="offerPlatforms" value="youtube">
          <img src="youtubelogo.png" alt="YouTube" title="YouTube" style="width:22px;vertical-align:middle;margin-right:3px;">
          YouTube
        </label>
        <label><input type="checkbox" name="offerPlatforms" value="tiktok">
          <img src="tiktoklogo.png" alt="Tiktok" title="Tiktok" style="width:22px;vertical-align:middle;margin-right:3px;">
          TikTok
        </label>
        <label><input type="checkbox" name="offerPlatforms" value="twitch">
          <img src="twitchlogo.png" alt="Twitch" title="Twitch" style="width:22px;vertical-align:middle;margin-right:3px;">
          Twitch
        </label>
        <label><input type="checkbox" name="offerPlatforms" value="twitter">
          <img src="twitterlogo.png" alt="Twitter" title="Twitter" style="width:22px;vertical-align:middle;margin-right:3px;">
          Twitter
        </label>
        <label><input type="checkbox" name="offerPlatforms" value="facebook">
          <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" alt="Facebook" title="Facebook" style="width:22px;vertical-align:middle;margin-right:3px;">
          Facebook
        </label>
        <label><input type="checkbox" name="offerPlatforms" value="snapchat">
          <img src="snaplogo.png" alt="Snapchat" title="Snapchat" style="width:22px;vertical-align:middle;margin-right:3px;">
          Snapchat
        </label>
      </div>

      <div class="help-block" id="images-help-block" style="margin-bottom:10px;">
        <em>
          <strong>Offer Images & Media:</strong><br>
          Upload up to 5 images to showcase your offer. Drag & drop or click to select files. You may also upload an optional supporting file (sample video, brief, etc).<br>
          Thumbnails can be removed or previewed before submitting.
        </em>
      </div>

      <label for="productImage">Offer Images:</label>
      <input type="file" id="productImage" name="productImage" accept="image/*" multiple><br><br>
      <div id="dropZone" class="drop-zone">
        <p>Drag & drop images here, or click "Choose Files"</p>
      </div><br>
      <div id="productImagePreviewContainer" class="image-preview-container">
        <div id="mainPreview" class="main-preview">
          <p><em>Preview will appear here.</em></p>
        </div>
        <div id="thumbnailGallery" class="thumbnail-gallery"></div>
      </div><br>
      <label for="optionalFile">Optional File Upload (e.g., sample video, ad clip):</label>
      <input type="file" id="optionalFile" name="optionalFile"><br><br>
      <button type="submit">Submit Public Offer</button>
    </fieldset>
  </section>
</form>

<footer class="footercomplete">
  <div class="footer-text">
    <ul>
      <li><a href="./help.html">Help</a></li>
      <li><a href="./contact.html">Contact</a></li>
      <li><a href="./privacy.html">Privacy Policy</a></li>
      <li><a href="./terms.html">Terms of Service</a></li>
      <li><a href="./reviews.html">Reviews</a></li>
    </ul>
  </div>
  <img src="Logo1.jpg" class="footpic" alt="Sponsor Sorter Logo" />
  <div style="margin-top:18px;font-size:0.98em;color:#bbb;">&copy; 2025 Sponsor Sorter. All rights reserved.</div>
</footer>

<script type="module">
import { supabase } from './js/supabaseClient.js';

// ====== Offer Presets ======
const PRESETS = {
  shoutout: {
    offerTitle: "Instagram Shoutout",
    offerDescription: "Get your brand noticed with an Instagram shoutout to my engaged followers.",
    price: 100,
    payment: "full_on_completion",
    jobType: "Shoutout",
    deliverableType: "Standalone Post",
    instructions: "Please provide your post copy, preferred hashtags, and mention accounts.",
    sponsorshipDuration: "One Off",
    offerPlatforms: ["instagram"],
  },
  youtube_review: {
    offerTitle: "YouTube Product Review",
    offerDescription: "I will feature your product in a dedicated YouTube review video.",
    price: 300,
    payment: "full_on_completion",
    jobType: "Product Placement",
    deliverableType: "Product Review",
    instructions: "Send your product to my PO box. Review will be honest and detailed.",
    sponsorshipDuration: "One Off",
    offerPlatforms: ["youtube"],
  },
  ongoing_monthly: {
    offerTitle: "Ongoing Monthly Sponsorship",
    offerDescription: "Monthly brand mention in every video, story, and social post.",
    price: 500,
    payment: "monthly",
    jobType: "Ongoing Deal",
    deliverableType: "Include in next video",
    instructions: "Your brand will be included in ongoing content for the sponsorship period.",
    sponsorshipDuration: "1 Month",
    offerPlatforms: ["youtube", "instagram"],
  },
  story_mention: {
    offerTitle: "Instagram Story Mention",
    offerDescription: "I'll mention your brand in a story for 24 hours with a swipe-up link.",
    price: 50,
    payment: "full_on_completion",
    jobType: "Story Mention",
    deliverableType: "Story Mention",
    instructions: "Provide story assets and swipe-up link.",
    sponsorshipDuration: "One Off",
    offerPlatforms: ["instagram"],
  },
  event: {
    offerTitle: "Event Sponsorship",
    offerDescription: "Become an official sponsor for my upcoming live event.",
    price: 1000,
    payment: "full_on_completion",
    jobType: "Event Sponsorship",
    deliverableType: "Custom Content",
    instructions: "Your logo and brand will be promoted across all event materials and streams.",
    sponsorshipDuration: "One Off",
    offerPlatforms: ["youtube", "instagram", "twitch"],
  }
};

let imageFiles = [];
let currentPreviewIndex = 0;

document.addEventListener('DOMContentLoaded', async () => {
  // --- Show/hide help blocks based on global user_settings ---
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    alert('Please log in first.');
    window.location.href = 'login.html';
    return;
  }
  const { data: settingsRow, error: settingsError } = await supabase
    .from('user_settings')
    .select('hide_help_blocks')
    .eq('user_id', user.id)
    .maybeSingle();
  let hideHelp = false;
  if (!settingsError && settingsRow && typeof settingsRow.hide_help_blocks === 'boolean') {
    hideHelp = !!settingsRow.hide_help_blocks;
  }
  document.querySelectorAll('.help-block').forEach(div => {
    div.style.display = hideHelp ? 'none' : '';
  });

  // --- Sponsor info (must be logged in) ---
  const { data: sponsorData, error: sponsorError } = await supabase
    .from('users_extended_data')
    .select('*')
    .eq('user_id', user.id)
    .single();
  if (sponsorError || !sponsorData) {
    alert('Sponsor data not found.');
    return;
  }
  document.getElementById('sponsor-email').innerText = sponsorData.email || '';
  document.getElementById('company').innerText = sponsorData.company_name || '';
  document.getElementById('sponsor-location').innerText = sponsorData.location || '';
  const sponsorPicElement = document.getElementById('sponsor-profile-pic');
  if (sponsorPicElement) {
    sponsorPicElement.src = sponsorData.profile_pic
      ? `https://mqixtrnhotqqybaghgny.supabase.co/storage/v1/object/public/logos/${sponsorData.profile_pic}`
      : 'logos.png';
  }

  // ====== Load Sponsor Overall Rating ======
  await loadSponsorOverallStars(sponsorData.username);

  // === Offer Preset Logic ===
  const presetSelect = document.getElementById('preset');
  const applyPresetBtn = document.getElementById('applyPresetBtn');
  if (presetSelect && applyPresetBtn) {
    applyPresetBtn.onclick = () => {
      const key = presetSelect.value;
      if (key && PRESETS[key]) {
        const p = PRESETS[key];
        document.getElementById('offerTitle').value = p.offerTitle;
        document.getElementById('offerDescription').value = p.offerDescription;
        document.getElementById('price').value = p.price;
        document.getElementById('payment').value = p.payment;
        document.getElementById('jobType').value = p.jobType;
        document.getElementById('deliverableType').value = p.deliverableType;
        document.getElementById('instructions').value = p.instructions;
        document.getElementById('sponsorshipDuration').value = p.sponsorshipDuration;
        document.querySelectorAll('input[name="offerPlatforms"]').forEach(cb => {
          cb.checked = (p.offerPlatforms.map(x => x.toLowerCase())).includes(cb.value.toLowerCase());
        });
      }
    };
  }

  // === IMAGE UPLOAD LOGIC ===
  imageFiles = [];
  currentPreviewIndex = 0;
  const productImageInput = document.getElementById('productImage');
  const dropZone = document.getElementById('dropZone');
  const mainPreview = document.getElementById('mainPreview');
  const thumbnailGallery = document.getElementById('thumbnailGallery');
  productImageInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    if (files.length) addImages(files);
  });
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });
  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
  });
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
    if (files.length) addImages(files);
  });
  dropZone.addEventListener('click', () => {
    productImageInput.click();
  });
  function addImages(files) {
    const remainingSlots = 5 - imageFiles.length;
    const filesToAdd = files.slice(0, remainingSlots);
    if (filesToAdd.length < files.length) {
      alert('You can only upload up to 5 images.');
    }
    filesToAdd.forEach(file => {
      const reader = new FileReader();
      reader.onload = (e) => {
        imageFiles.push({ file, dataUrl: e.target.result });
        renderThumbnails();
        showPreview(imageFiles.length - 1);
      };
      reader.readAsDataURL(file);
    });
  }
  function renderThumbnails() {
    thumbnailGallery.innerHTML = '';
    imageFiles.forEach((imgObj, index) => {
      const thumbContainer = document.createElement('div');
      thumbContainer.classList.add('thumbnail-container');
      const thumb = document.createElement('img');
      thumb.src = imgObj.dataUrl;
      thumb.classList.add('thumbnail');
      thumb.addEventListener('click', () => showPreview(index));
      const removeBtn = document.createElement('button');
      removeBtn.innerText = '✖';
      removeBtn.classList.add('remove-thumb-btn');
      removeBtn.title = 'Remove this image';
      removeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        removeImage(index);
      });
      thumbContainer.appendChild(thumb);
      thumbContainer.appendChild(removeBtn);
      thumbnailGallery.appendChild(thumbContainer);
    });
  }
  function showPreview(index) {
    if (imageFiles.length === 0 || index < 0) {
      mainPreview.innerHTML = '<p><em>No images selected.</em></p>';
      return;
    }
    const img = document.createElement('img');
    img.src = imageFiles[index].dataUrl;
    mainPreview.innerHTML = '';
    mainPreview.appendChild(img);
    currentPreviewIndex = index;
  }
  function removeImage(index) {
    imageFiles.splice(index, 1);
    renderThumbnails();
    if (currentPreviewIndex === index) {
      showPreview(imageFiles.length ? 0 : -1);
    } else if (currentPreviewIndex > index) {
      currentPreviewIndex--;
    }
  }

  // === SUBMIT PUBLIC OFFER ===
  const offerForm = document.getElementById('offerForm');
  offerForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Gather all form data
    const title = document.getElementById('offerTitle').value.trim();
    const description = document.getElementById('offerDescription').value.trim();
    const amount = parseFloat(document.getElementById('price').value);
    const payment = document.getElementById('payment').value;
    const jobType = document.getElementById('jobType').value;
    const deliverableType = document.getElementById('deliverableType').value;
    const instructions = document.getElementById('instructions').value;
    const sponsorshipDuration = document.getElementById('sponsorshipDuration').value;
    const deadline = document.getElementById('deadline').value;
    const maxApplicants = parseInt(document.getElementById('maxApplicants').value) || null;
    const minFollowers = parseInt(document.getElementById('minFollowers').value) || null;
    const audienceCountry = document.getElementById('audienceCountry').value.trim() || null;
    const platforms = Array.from(document.querySelectorAll('input[name="offerPlatforms"]:checked')).map(cb => cb.value.toLowerCase());

    // 1. Upload images
    const uploadedImageNames = [];
    for (let i = 0; i < imageFiles.length; i++) {
      const { file } = imageFiles[i];
      const uniqueName = `${crypto.randomUUID()}_${file.name}`;
      const { error: uploadError } = await supabase
        .storage
        .from('offers')
        .upload(uniqueName, file, { cacheControl: '3600', upsert: false });
      if (uploadError) {
        alert(`Failed to upload ${file.name}`);
        return;
      }
      uploadedImageNames.push(uniqueName);
    }

    // 2. Upload optional file (if any)
    const optionalFileInput = document.getElementById('optionalFile');
    const optionalFile = optionalFileInput.files[0];
    let optionalFileName = null;
    if (optionalFile) {
      const uniqueOptFileName = `${crypto.randomUUID()}_${optionalFile.name}`;
      const { error: optionalUploadError } = await supabase
        .storage
        .from('offers')
        .upload(uniqueOptFileName, optionalFile, { cacheControl: '3600', upsert: false });
      if (optionalUploadError) {
        alert('Optional file upload failed.');
        return;
      }
      optionalFileName = uniqueOptFileName;
    }

    // 3. Save to public_offers
    const { error: insertError } = await supabase
      .from('public_offers')
      .insert([{
        sponsor_id: sponsorData.user_id || sponsorData.id,
        sponsor_email: sponsorData.email,
        sponsor_username: sponsorData.username,
        sponsor_company: sponsorData.company_name,
        offer_title: title,
        offer_description: description,
        offer_amount: amount,
        payment_schedule: payment,
        job_type: jobType,
        deliverable_type: deliverableType,
        instructions: instructions,
        sponsorship_duration: sponsorshipDuration,
        deadline: deadline,
        offer_images: uploadedImageNames,
        optional_file: optionalFileName,
        platforms: platforms,
        status: 'open',
        max_applicants: maxApplicants,
        min_followers: minFollowers,
        audience_country: audienceCountry
      }]);
    if (insertError) {
      alert('Failed to submit public offer.');
      return;
    }
    alert('Public offer submitted successfully!');
    offerForm.reset();
    window.location.href = "./dashboardsponsor.html";
  });
});

function renderStars(rating) {
  let out = '';
  for (let i = 1; i <= 5; i++) {
    out += `<span class="star${i <= rating ? ' gold-star' : ''}">${i <= rating ? '★' : '☆'}</span>`;
  }
  return out;
}

async function loadSponsorOverallStars(sponsorUsername) {
  const avgStarsElem = document.getElementById('sponsor-average-stars');
  if (!sponsorUsername || !avgStarsElem) {
    if (avgStarsElem) avgStarsElem.innerHTML = renderStars(0);
    return;
  }
  const { data: offers } = await supabase
    .from('private_offers')
    .select('id')
    .eq('sponsor_username', sponsorUsername);
  if (!offers || offers.length === 0) {
    avgStarsElem.innerHTML = renderStars(0);
    return;
  }
  const offerIds = offers.map(o => o.id);
  let overall = [];
  for (let i = 0; i < offerIds.length; i += 100) {
    const batchIds = offerIds.slice(i, i + 100);
    const { data: reviews } = await supabase
      .from('private_offer_reviews')
      .select('overall')
      .in('offer_id', batchIds)
      .eq('reviewer_role', 'sponsee');
    if (reviews) {
      overall = overall.concat(reviews.map(r => typeof r.overall === "string" ? parseFloat(r.overall) : r.overall || 0));
    }
  }
  function avg(arr) { return arr.length ? arr.reduce((a,b) => a+b,0)/arr.length : 0; }
  const ratingAvg = Math.round(avg(overall));
  avgStarsElem.innerHTML = renderStars(ratingAvg);
}
</script>
</body>
</html>
