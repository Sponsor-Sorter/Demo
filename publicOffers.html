<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Create Public Offer - Sponsor Sorter">
  <title>Post Public Offer | Sponsor Sorter</title>
  <link rel="stylesheet" href="./styles.css" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon">
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>

<header class="navbar1">
  <section class="navbar">
    <div class="navii">
      <h5><header>Sponsor Sorter</header></h5>
      <div>
        <background-img class="navimg" src="./navimg.png" alt=""></background-img>
        <nav>
          <li><a href="./index.html">Home</a></li>
          <li><a href="./finder.html">Finder</a></li>
        </nav>
        <nav>
          <li class="navr" id="auth-link"><a href="./dashboardsponsor.html">Dashboard</a></li>
          <li><a href="./login.html">Logout</a></li>
        </nav>
      </div>
    </div>
  </section>
</header>

<section class="userprofile">
  <fieldset>
    <legend>Your Sponsor Profile</legend>
    <div class="profile-header">
      <div class="profile-picture">
        <img id="sponsor-profile-pic" onerror="this.src='logos.png';" alt="Profile Picture" class="profile-img">
        <p>Account Type: <span id="account-type">Sponsor</span></p>
        <div id="sponsor-overall-rating" style="margin-top: 10px;">
          <strong>Overall Rating:</strong> <span id="sponsor-average-stars">â˜†â˜†â˜†â˜†â˜†</span>
        </div>
      </div>
      <div class="profile-info">
        <p>Email: <span id="sponsor-email">[Email]</span></p>
        <p>Company: <span id="company">[Company]</span></p>
        <p>Location: <span id="sponsor-location">[Location]</span></p>
      </div>
    </div>
    <div class="help-block" id="profile-help-block" style="margin-top:10px;margin-bottom:8px;">
      <em>
        <strong>Profile Information:</strong><br>
        This section displays your sponsor account details as seen by sponsees on public offers. Please keep your info up to date in your account settings for trust and visibility.
      </em>
    </div>
  </fieldset>
</section>

<form id="offerForm" enctype="multipart/form-data">
  <section>
    <fieldset>
      <legend>Create Public Offer Below</legend>
      <div class="help-block" id="offer-help-block" style="margin-bottom:12px;">
        <em>
          <strong>Offer Creation Help:</strong><br>
          Fill out this form to create a new public sponsorship offer. You can use the presets to autofill common offers, or enter your own details. Make sure to include a clear title, description, and set relevant requirements. Fields marked <b>required</b> must be filled in.
        </em>
      </div>

      <label for="preset">Offer Preset:</label>
      <select id="preset" name="preset">
        <option value="">-- Select a Preset --</option>
        <option value="shoutout">Instagram Shoutout</option>
        <option value="youtube_review">YouTube Product Review</option>
        <option value="ongoing_monthly">Ongoing Monthly Sponsorship</option>
        <option value="story_mention">Instagram Story Mention</option>
        <option value="event">Event Sponsorship</option>
      </select>
      <button type="button" id="applyPresetBtn" style="margin-left:8px;">Apply Preset</button>
      <span class="info-icon" data-tooltip="Use presets to autofill common offers.">ðŸ›ˆ</span>
      <br><br>

      <fieldset>
        <label for="offerTitle">Offer Title / Campaign Name:</label>
        <input type="text" id="offerTitle" name="offerTitle" required>
        <span class="info-icon" data-tooltip="Give your offer a catchy campaign name. This is what creators will see first.">ðŸ›ˆ</span><br><br>

        <div class="form-group">
          <label for="deadline">Deadline:</label>
          <input type="date" id="deadline" name="deadline" required>
          <span class="info-icon" data-tooltip="Date by which job must be completed by.">ðŸ›ˆ</span>
        </div>

        <label for="offerDescription">Offer Description:</label><br>
        <textarea id="offerDescription" name="offerDescription" rows="4" cols="50" required></textarea><br><br>

        <div class="form-double-row">
          <div class="form-group">
            <label for="jobType">Type of Job:</label>
            <select id="jobType" name="jobType" required>
              <option value="">--Select Type--</option>
              <option value="Shoutout">Shoutout</option>
              <option value="Product Placement">Product Placement</option>
              <option value="Dedicated Video">Dedicated Video</option>
              <option value="Story Mention">Story Mention</option>
              <option value="Event Sponsorship">Event Sponsorship</option>
              <option value="Ongoing Deal">Ongoing Deal</option>
            </select>
            <span class="info-icon" data-tooltip="The type of Offer you are asking for.">ðŸ›ˆ</span>
          </div>

          <div class="form-group">
            <label for="deliverableType">Deliverable Type:</label>
            <span class="info-icon" data-tooltip="How the offers job will be delivered to the public.">ðŸ›ˆ</span>
            <select id="deliverableType" name="deliverableType" required>
              <option value="">--Select Deliverable--</option>
              <option value="Include in next video">Include in Next Video</option>
              <option value="Standalone Post">Standalone Post</option>
              <option value="Story Mention">Story Mention</option>
              <option value="Product Review">Product Review</option>
              <option value="Custom Content">Custom Content</option>
            </select>
          </div>
        </div>

        <label for="instructions">Instructions:</label><br>
        <textarea id="instructions" name="instructions" rows="4" cols="50"></textarea><br><br>
      </fieldset>

      <fieldset>
        <label for="sponsorshipDuration">Sponsorship Duration:</label>
        <select id="sponsorshipDuration" name="sponsorshipDuration" required>
          <option value="">--Select Duration--</option>
          <option value="One Off">One-off</option>
          <option value="1 Month">1 Month</option>
          <option value="3 Months">3 Months</option>
          <option value="6 Months">6 Months</option>
          <option value="1 Year">1 Year</option>
        </select>
        <span class="info-icon" data-tooltip="How long sponsorship will last.">ðŸ›ˆ</span>
        <br><br>

        <div class="form-double-row">
          <div class="form-group">
            <label for="price">Offer Amount (USD):</label>
            <input type="number" id="price" name="price" step="1" min="1" required>
            <span class="info-icon" data-tooltip="How much each Sponsee will recieve upon completion.">ðŸ›ˆ</span>
          </div>
          <div class="form-group">
            <label for="payment">Payment Cycle:</label>
            <span class="info-icon" data-tooltip="Frequency at which Sponsee will be paid.">ðŸ›ˆ</span>
            <select id="payment" name="payment" required>
              <option value="">--Select--</option>
              <option value="weekly">Weekly</option>
              <option value="fortnightly">Fortnightly</option>
              <option value="monthly">Monthly</option>
              <option value="full on completion">FULL - On Completion</option>
            </select>
          </div>
        </div>

        <div class="form-double-row">
          <div class="form-group">
            <label for="cycleCount"># of Cycles:</label>
            <input type="number" id="cycleCount" name="cycleCount" min="1" value="1" style="width: 90px;" required>
            <span class="info-icon" data-tooltip="How many times this payment cycle will repeat. For a 3-month deal, enter 3. For a one-off deal, leave at 1.">ðŸ›ˆ</span>
          </div>

          <div class="form-group">
            <label for="maxApplicants">Max Applicants:</label>
            <span class="info-icon" data-tooltip="The max number of successful Applicants.">ðŸ›ˆ</span>
            <input type="number" id="maxApplicants" name="maxApplicants" min="1" placeholder="E.g. 100">
          </div>
        </div>

        <fieldset style="border-color: aliceblue; margin-top: 20px;">
          <legend>Cost:</legend>
          <div id="offer-cost-summary" style="font-size: 1.12em; color: #e0eaff; margin-bottom: 6px; font-weight: 500;">
            Total Cost: <span id="offer-cost-amount" style="color: #6fe3d9;">$0.00</span>
            <span id="cost-cycle-label" style="color:#fff; opacity:.7;"></span>
          </div>
          <div id="listing-fee-line" style="font-size: 1.04em; color: #FFD600; margin-bottom: 4px;">
            Listing Fee (5% + $5/applicant/cycle): <span id="listing-fee-amount" style="color:#ffc97b;">$0.00</span>
          </div>
          <div id="total-cost-line" style="font-size: 1.14em; color: #99f1b8;">
            Total Including Fee: <span id="total-cost-amount" style="color:#50ffa4;">$0.00</span>
          </div>
          <div id="cost-details" style="font-size: .99em; color: #c7dcfc;">
            The sponsor pays the Offer Amount Ã— Max Applicants Ã— # of Cycles.<br>
            <b>Listing Fee:</b> 5% of this amount + $5 per applicant per cycle.<br>
            This fee covers secure payment processing and platform operations.
          </div>
        </fieldset>
      </fieldset>

      <fieldset>
        <div class="form-double-row">
          <div class="form-group">
            <label for="minFollowers">Min Followers Required:</label>
            <input type="number" id="minFollowers" name="minFollowers" min="0" placeholder="E.g. 5000">
            <span class="info-icon" data-tooltip="Minimum amount of followers on platform.">ðŸ›ˆ</span>
          </div>
          <div class="form-group">
            <label for="audienceCountry">Audience Country (primary):</label>
            <span class="info-icon" data-tooltip="Primary country you want to direct the offer to. (This can be helpful if your looking for a sponsee in a specific demographic area)">ðŸ›ˆ</span>
            <input type="text" id="audienceCountry" name="audienceCountry" maxlength="80" placeholder="E.g. Australia">
          </div>
        </div>

        <label>Offer Platforms:</label>
        <span class="info-icon" data-tooltip="Select 1 or more platforms where your Sponsee(s) will deliver your offer. ">ðŸ›ˆ</span>
        <div id="platformCheckboxes" style="margin-bottom:12px;">
          <label><input type="checkbox" name="offerPlatforms" value="instagram">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/95/Instagram_logo_2022.svg/1200px-Instagram_logo_2022.svg.png" alt="Instagram" title="Instagram" style="width:22px;vertical-align:middle;margin-right:3px;">
            Instagram
          </label>
          <label><input type="checkbox" name="offerPlatforms" value="youtube">
            <img src="./youtubelogo.png" alt="YouTube" title="YouTube" style="width:22px;vertical-align:middle;margin-right:3px;">
            YouTube
          </label>
          <label><input type="checkbox" name="offerPlatforms" value="tiktok">
            <img src="./tiktoklogo.png" alt="Tiktok" title="Tiktok" style="width:22px;vertical-align:middle;margin-right:3px;">
            TikTok
          </label>
          <label><input type="checkbox" name="offerPlatforms" value="twitch">
            <img src="./twitchlogo.png" alt="Twitch" title="Twitch" style="width:22px;vertical-align:middle;margin-right:3px;">
            Twitch
          </label>
          <label><input type="checkbox" name="offerPlatforms" value="twitter">
            <img src="./twitterlogo.png" alt="Twitter" title="Twitter" style="width:22px;vertical-align:middle;margin-right:3px;">
            Twitter
          </label>
          <label><input type="checkbox" name="offerPlatforms" value="facebook">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" alt="Facebook" title="Facebook" style="width:22px;vertical-align:middle;margin-right:3px;">
            Facebook
          </label>
          <label><input type="checkbox" name="offerPlatforms" value="snapchat">
            <img src="./snaplogo.png" alt="Snapchat" title="Snapchat" style="width:22px;vertical-align:middle;margin-right:3px;">
            Snapchat
          </label>
        </div>
      </fieldset>

      <fieldset>
        <div class="help-block" id="images-help-block" style="margin-bottom:10px;">
          <em>
            <strong>Offer Images & Media:</strong><br>
            Upload up to 5 images to showcase your offer. Drag & drop or click to select files. You may also upload an optional supporting file (sample video, brief, etc).<br>
            Thumbnails can be removed or previewed before submitting.
          </em>
        </div>

        <label for="productImage">Offer Images:</label>
        <span class="info-icon" data-tooltip="Add Images relating to your Offer. Things like products.">ðŸ›ˆ</span>
        <input type="file" id="productImage" name="productImage" accept="image/*" multiple><br><br>

        <div id="dropZone" class="drop-zone">
          <p>Drag & drop images here, or click "Choose Files"</p>
        </div><br>

        <div id="productImagePreviewContainer" class="image-preview-container">
          <div id="mainPreview" class="main-preview">
            <p><em>Preview will appear here.</em></p>
          </div>
          <div id="thumbnailGallery" class="thumbnail-gallery"></div>
        </div><br>

        <label for="optionalFile">Optional File Upload (e.g., sample video, ad clip):</label>
        <input type="file" id="optionalFile" name="optionalFile"><br><br>

        <button type="submit">Submit Public Offer</button>
      </fieldset>

    </fieldset>
  </section>
</form>

<footer class="footercomplete">
  <div class="footer-text">
    <ul>
      <li><a href="./help.html">Help</a></li>
      <li><a href="./contact.html">Contact</a></li>
      <li><a href="./privacy.html">Privacy Policy</a></li>
      <li><a href="./terms.html">Terms of Service</a></li>
      <li><a href="./reviews.html">Reviews</a></li>
    </ul>
  </div>
  <img src="./Logo1.jpg" class="footpic" alt="Sponsor Sorter Logo" />
  <div style="margin-top:18px;font-size:0.98em;color:#bbb;">&copy; 2025 Sponsor Sorter. All rights reserved.</div>
</footer>

<script type="module">
import { supabase } from './js/supabaseClient.js';
import { famBotModerateWithModal } from './js/FamBot.js';

const STRIPE_BACKEND = "https://mqixtrnhotqqybaghgny.supabase.co/functions/v1/stripe-checkout";

// NOTE: Replace with LIVE key when live
const STRIPE_PK = 'pk_test_51RSqPq2eA1800fRNY8mN2SAy3gtGYMjaO6gzNWyl0FW87ltVe45yX6sm0EAX53Y1jyi081SXNI3pQMgCjOQrJ3co00uVPw3xC3';

// ====== Offer Presets ======
const PRESETS = {
  shoutout: {
    offerTitle: "Instagram Shoutout",
    offerDescription: "Get your brand noticed with an Instagram shoutout to my engaged followers.",
    price: 100,
    payment: "full on completion",
    jobType: "Shoutout",
    deliverableType: "Standalone Post",
    instructions: "Please provide your post copy, preferred hashtags, and mention accounts.",
    sponsorshipDuration: "One Off",
    offerPlatforms: ["instagram"],
  },
  youtube_review: {
    offerTitle: "YouTube Product Review",
    offerDescription: "I will feature your product in a dedicated YouTube review video.",
    price: 300,
    payment: "full on completion",
    jobType: "Product Placement",
    deliverableType: "Product Review",
    instructions: "Send your product to my PO box. Review will be honest and detailed.",
    sponsorshipDuration: "One Off",
    offerPlatforms: ["youtube"],
  },
  ongoing_monthly: {
    offerTitle: "Ongoing Monthly Sponsorship",
    offerDescription: "Monthly brand mention in every video, story, and social post.",
    price: 500,
    payment: "monthly",
    jobType: "Ongoing Deal",
    deliverableType: "Include in next video",
    instructions: "Your brand will be included in ongoing content for the sponsorship period.",
    sponsorshipDuration: "1 Month",
    offerPlatforms: ["youtube", "instagram"],
  },
  story_mention: {
    offerTitle: "Instagram Story Mention",
    offerDescription: "I'll mention your brand in a story for 24 hours with a swipe-up link.",
    price: 50,
    payment: "full on completion",
    jobType: "Story Mention",
    deliverableType: "Story Mention",
    instructions: "Provide story assets and swipe-up link.",
    sponsorshipDuration: "One Off",
    offerPlatforms: ["instagram"],
  },
  event: {
    offerTitle: "Event Sponsorship",
    offerDescription: "Become an official sponsor for my upcoming live event.",
    price: 1000,
    payment: "full on completion",
    jobType: "Event Sponsorship",
    deliverableType: "Custom Content",
    instructions: "Your logo and brand will be promoted across all event materials and streams.",
    sponsorshipDuration: "One Off",
    offerPlatforms: ["youtube", "instagram", "twitch"],
  }
};

let imageFiles = [];
let currentPreviewIndex = 0;

document.addEventListener('DOMContentLoaded', async () => {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    alert('Please log in first.');
    window.location.href = './login.html';
    return;
  }

  const { data: settingsRow } = await supabase
    .from('user_settings')
    .select('hide_help_blocks')
    .eq('user_id', user.id)
    .maybeSingle();

  let hideHelp = !!(settingsRow && typeof settingsRow.hide_help_blocks === 'boolean' && settingsRow.hide_help_blocks);
  document.querySelectorAll('.help-block').forEach(div => {
    div.style.display = hideHelp ? 'none' : '';
  });

  const { data: sponsorData, error: sponsorError } = await supabase
    .from('users_extended_data')
    .select('*')
    .eq('user_id', user.id)
    .single();

  if (sponsorError || !sponsorData) {
    alert('Sponsor data not found.');
    return;
  }

  document.getElementById('sponsor-email').innerText = sponsorData.email || '';
  document.getElementById('company').innerText = sponsorData.company_name || '';
  document.getElementById('sponsor-location').innerText = sponsorData.location || '';

  const sponsorPicElement = document.getElementById('sponsor-profile-pic');
  if (sponsorPicElement) {
    sponsorPicElement.src = sponsorData.profile_pic
      ? `https://mqixtrnhotqqybaghgny.supabase.co/storage/v1/object/public/logos/${sponsorData.profile_pic}`
      : 'logos.png';
  }

  await loadSponsorOverallStars(sponsorData.username);

  // === Offer Preset Logic ===
  const presetSelect = document.getElementById('preset');
  const applyPresetBtn = document.getElementById('applyPresetBtn');
  if (presetSelect && applyPresetBtn) {
    applyPresetBtn.onclick = () => {
      const key = presetSelect.value;
      if (key && PRESETS[key]) {
        const p = PRESETS[key];
        document.getElementById('offerTitle').value = p.offerTitle;
        document.getElementById('offerDescription').value = p.offerDescription;
        document.getElementById('price').value = p.price;
        document.getElementById('payment').value = p.payment;
        document.getElementById('jobType').value = p.jobType;
        document.getElementById('deliverableType').value = p.deliverableType;
        document.getElementById('instructions').value = p.instructions;
        document.getElementById('sponsorshipDuration').value = p.sponsorshipDuration;
        document.querySelectorAll('input[name="offerPlatforms"]').forEach(cb => {
          cb.checked = (p.offerPlatforms.map(x => x.toLowerCase())).includes(cb.value.toLowerCase());
        });
        autoFillCycles();
        calcCost();
      }
    };
  }

  // === IMAGE UPLOAD LOGIC ===
  imageFiles = [];
  currentPreviewIndex = 0;
  const productImageInput = document.getElementById('productImage');
  const dropZone = document.getElementById('dropZone');
  const mainPreview = document.getElementById('mainPreview');
  const thumbnailGallery = document.getElementById('thumbnailGallery');

  productImageInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    if (files.length) addImages(files);
  });

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
    if (files.length) addImages(files);
  });

  dropZone.addEventListener('click', () => {
    productImageInput.click();
  });

  function addImages(files) {
    const remainingSlots = 5 - imageFiles.length;
    const filesToAdd = files.slice(0, remainingSlots);
    if (filesToAdd.length < files.length) {
      alert('You can only upload up to 5 images.');
    }
    filesToAdd.forEach(file => {
      const reader = new FileReader();
      reader.onload = (e) => {
        imageFiles.push({ file, dataUrl: e.target.result });
        renderThumbnails();
        showPreview(imageFiles.length - 1);
      };
      reader.readAsDataURL(file);
    });
  }

  function renderThumbnails() {
    thumbnailGallery.innerHTML = '';
    imageFiles.forEach((imgObj, index) => {
      const thumbContainer = document.createElement('div');
      thumbContainer.classList.add('thumbnail-container');

      const thumb = document.createElement('img');
      thumb.src = imgObj.dataUrl;
      thumb.classList.add('thumbnail');
      thumb.addEventListener('click', () => showPreview(index));

      const removeBtn = document.createElement('button');
      removeBtn.innerText = 'âœ–';
      removeBtn.classList.add('remove-thumb-btn');
      removeBtn.title = 'Remove this image';
      removeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        removeImage(index);
      });

      thumbContainer.appendChild(thumb);
      thumbContainer.appendChild(removeBtn);
      thumbnailGallery.appendChild(thumbContainer);
    });
  }

  function showPreview(index) {
    if (imageFiles.length === 0 || index < 0) {
      mainPreview.innerHTML = '<p><em>No images selected.</em></p>';
      return;
    }
    const img = document.createElement('img');
    img.src = imageFiles[index].dataUrl;
    mainPreview.innerHTML = '';
    mainPreview.appendChild(img);
    currentPreviewIndex = index;
  }

  function removeImage(index) {
    imageFiles.splice(index, 1);
    renderThumbnails();
    if (currentPreviewIndex === index) {
      showPreview(imageFiles.length ? 0 : -1);
    } else if (currentPreviewIndex > index) {
      currentPreviewIndex--;
    }
  }

  // === FORM SUBMIT + STRIPE PAYMENT ===
  const offerForm = document.getElementById('offerForm');
  offerForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const title = document.getElementById('offerTitle').value.trim();
    const description = document.getElementById('offerDescription').value.trim();
    const amount = parseFloat(document.getElementById('price').value);
    const payment = document.getElementById('payment').value;
    const jobType = document.getElementById('jobType').value;
    const deliverableType = document.getElementById('deliverableType').value;
    const instructions = document.getElementById('instructions').value;
    const sponsorshipDuration = document.getElementById('sponsorshipDuration').value;
    const deadline = document.getElementById('deadline').value;
    const maxApplicants = parseInt(document.getElementById('maxApplicants').value) || 1;
    const minFollowers = parseInt(document.getElementById('minFollowers').value) || null;
    const audienceCountry = document.getElementById('audienceCountry').value.trim() || null;
    const platforms = Array.from(document.querySelectorAll('input[name="offerPlatforms"]:checked')).map(cb => cb.value.toLowerCase());
    const cycles = parseInt(document.getElementById('cycleCount').value) || 1;

    // ==== FamBot Moderation ====
    const { data: { session } } = await supabase.auth.getSession();
    const user_id = session?.user.id;
    const jwt = session?.access_token;

    const fieldsToModerate = [
      { content: title, type: 'offer' },
      { content: description, type: 'offer' },
      { content: instructions, type: 'offer' }
    ];
    for (const field of fieldsToModerate) {
      if (field.content && field.content.length > 0) {
        const result = await famBotModerateWithModal({
          user_id,
          content: field.content,
          jwt,
          type: field.type
        });
        if (!result.allowed) return;
      }
    }
    // ==== End FamBot Moderation ====

    // 1. Upload images
    const uploadedImageNames = [];
    for (let i = 0; i < imageFiles.length; i++) {
      const { file } = imageFiles[i];
      const uniqueName = `${crypto.randomUUID()}_${file.name}`;
      const { error: uploadError } = await supabase
        .storage
        .from('offers')
        .upload(uniqueName, file, { cacheControl: '3600', upsert: false });

      if (uploadError) {
        alert(`Failed to upload ${file.name}`);
        return;
      }
      uploadedImageNames.push(uniqueName);
    }

    // 2. Upload optional file (if any)
    const optionalFileInput = document.getElementById('optionalFile');
    const optionalFile = optionalFileInput.files[0];
    let optionalFileName = null;
    if (optionalFile) {
      const uniqueOptFileName = `${crypto.randomUUID()}_${optionalFile.name}`;
      const { error: optionalUploadError } = await supabase
        .storage
        .from('offers')
        .upload(uniqueOptFileName, optionalFile, { cacheControl: '3600', upsert: false });

      if (optionalUploadError) {
        alert('Optional file upload failed.');
        return;
      }
      optionalFileName = uniqueOptFileName;
    }

    // 3. Prepare offer data and save to localStorage for after payment
    const offerData = {
      sponsor_id: sponsorData.user_id || sponsorData.id,
      sponsor_email: sponsorData.email,
      sponsor_username: sponsorData.username,
      sponsor_company: sponsorData.company_name,
      offer_title: title,
      offer_description: description,
      offer_amount: amount,
      payment_schedule: payment,
      job_type: jobType,
      deliverable_type: deliverableType,
      instructions: instructions,
      sponsorship_duration: sponsorshipDuration,
      deadline: deadline,
      offer_images: uploadedImageNames,
      optional_file: optionalFileName,
      platforms: platforms,
      status: 'open',
      max_applicants: maxApplicants,
      min_followers: minFollowers,
      audience_country: audienceCountry,
      cycles: cycles,
    };

    localStorage.setItem('pendingOfferData', JSON.stringify(offerData));

    // 4. Calculate total + NEW fee model
    const total = amount * maxApplicants * cycles;

    // NEW: 5% of total + $5 per applicant per cycle
    const fee = (total * 0.05) + (5 * maxApplicants * cycles);
    const totalWithFee = total + fee;

    // 5. Start Stripe Checkout
    try {
      const { data: { session } } = await supabase.auth.getSession();
      const jwt = session?.access_token;

      const frontendBaseUrl = window.location.origin.includes('github.io')
        ? 'https://sponsor-sorter.github.io/Demo'
        : window.location.origin;

      const sessionRes = await fetch(STRIPE_BACKEND, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(jwt ? { 'Authorization': `Bearer ${jwt}` } : {})
        },
        body: JSON.stringify({
          amount: totalWithFee,
          offerId: title + '-' + Date.now(),
          offerType: 'public',
          frontendBaseUrl
        })
      });

      const sessionData = await sessionRes.json();
      if (!sessionData.sessionId) {
        alert('Could not start payment. ' + (sessionData.error || 'Unknown error.'));
        return;
      }

      const stripe = Stripe(STRIPE_PK);
      const { error } = await stripe.redirectToCheckout({ sessionId: sessionData.sessionId });
      if (error) {
        alert('Stripe redirect failed: ' + error.message);
        return;
      }
    } catch (err) {
      alert('Failed to initiate payment: ' + err.message);
      return;
    }
  });
});

// Helper functions

function renderStars(rating) {
  let out = '';
  for (let i = 1; i <= 5; i++) {
    out += `<span class="star${i <= rating ? ' gold-star' : ''}">${i <= rating ? 'â˜…' : 'â˜†'}</span>`;
  }
  return out;
}

async function loadSponsorOverallStars(sponsorUsername) {
  const avgStarsElem = document.getElementById('sponsor-average-stars');
  if (!sponsorUsername || !avgStarsElem) {
    if (avgStarsElem) avgStarsElem.innerHTML = renderStars(0);
    return;
  }
  const { data: offers } = await supabase
    .from('private_offers')
    .select('id')
    .eq('sponsor_username', sponsorUsername);

  if (!offers || offers.length === 0) {
    avgStarsElem.innerHTML = renderStars(0);
    return;
  }

  const offerIds = offers.map(o => o.id);
  let overall = [];

  for (let i = 0; i < offerIds.length; i += 100) {
    const batchIds = offerIds.slice(i, i + 100);
    const { data: reviews } = await supabase
      .from('private_offer_reviews')
      .select('overall')
      .in('offer_id', batchIds)
      .eq('reviewer_role', 'sponsee');

    if (reviews) {
      overall = overall.concat(reviews.map(r => typeof r.overall === "string" ? parseFloat(r.overall) : r.overall || 0));
    }
  }

  function avg(arr) { return arr.length ? arr.reduce((a,b) => a+b,0)/arr.length : 0; }
  const ratingAvg = Math.round(avg(overall));
  avgStarsElem.innerHTML = renderStars(ratingAvg);
}

function calcCost() {
  const price = parseFloat(document.getElementById('price').value) || 0;
  const applicants = parseInt(document.getElementById('maxApplicants').value) || 1;
  const payment = document.getElementById('payment').value || '';
  const cycles = parseInt(document.getElementById('cycleCount').value) || 1;

  const total = price * applicants * cycles;

  // NEW: 5% of total + $5 per applicant per cycle
  const fee = (total * 0.05) + (5 * applicants * cycles);
  const totalWithFee = total + fee;

  let cycle = '';
  if (payment === 'weekly') cycle = `per week Ã— ${cycles} week${cycles>1?'s':''}`;
  else if (payment === 'fortnightly') cycle = `per fortnight Ã— ${cycles} fortnight${cycles>1?'s':''}`;
  else if (payment === 'monthly') cycle = `per month Ã— ${cycles} month${cycles>1?'s':''}`;
  else if (payment === 'full on completion') cycle = `(one-off, on completion)`;

  document.getElementById('offer-cost-amount').textContent =
    '$' + total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('cost-cycle-label').textContent = cycle ? ` ${cycle}` : '';
  document.getElementById('listing-fee-amount').textContent =
    '$' + fee.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('total-cost-amount').textContent =
    '$' + totalWithFee.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

// Attach listeners for all involved fields:
['price', 'maxApplicants', 'payment', 'cycleCount'].forEach(id => {
  document.getElementById(id).addEventListener('input', calcCost);
  document.getElementById(id).addEventListener('change', calcCost);
});

function autoFillCycles() {
  const duration = document.getElementById('sponsorshipDuration').value;
  const payment = document.getElementById('payment').value;
  let cycles = 1;

  const d = (duration || '').toLowerCase();
  const p = (payment || '').toLowerCase();

  if (d === 'one off' || p === 'full on completion') {
    cycles = 1;
  } else if (p === 'monthly') {
    if (d === '1 month') cycles = 1;
    else if (d === '3 months') cycles = 3;
    else if (d === '6 months') cycles = 6;
    else if (d === '1 year') cycles = 12;
  } else if (p === 'weekly') {
    if (d === '1 month') cycles = 4;
    else if (d === '3 months') cycles = 12;
    else if (d === '6 months') cycles = 24;
    else if (d === '1 year') cycles = 52;
  } else if (p === 'fortnightly') {
    if (d === '1 month') cycles = 2;
    else if (d === '3 months') cycles = 6;
    else if (d === '6 months') cycles = 12;
    else if (d === '1 year') cycles = 26;
  }

  document.getElementById('cycleCount').value = cycles;
  calcCost();
}

document.getElementById('sponsorshipDuration').addEventListener('change', autoFillCycles);
document.getElementById('payment').addEventListener('change', autoFillCycles);

calcCost();
</script>

</body>
</html>
