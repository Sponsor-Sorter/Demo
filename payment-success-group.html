<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Payment Success - Sponsor Sorter">
  <title>Payment Success | Sponsor Sorter</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
<header class="navbar1">
  <section class="navbar">
    <div class="navii">
      <h5><header>Sponsor Sorter</header></h5>
      <div>
        <background-img class="navimg" src="navimg.png" alt="">
        <nav>
          <li><a href="index.html">Home</a></li>
          <li><a href="finder.html">Finder</a></li>
        </nav>
        <nav>
          <li class="navr" id="auth-link"><a href="./dashboardsponsor.html">Dashboard</a></li>
          <li><a href="login.html">Logout</a></li>
        </nav>
      </div>
    </div>
  </section>
</header>

<main style="min-height:40vh;">
  <div style="max-width:500px;margin:38px auto;padding:24px 28px;background:#f5f8ff;border-radius:14px;box-shadow:0 2px 24px 0 #e2e2e2;">
    <h2 style="color:green;">ðŸŽ‰ Payment successful!</h2>
    <div id="insert-status">Submitting your group offer to the selected group...</div>
  </div>
</main>

<footer class="footercomplete">
  <div class="footer-text">
    <ul>
      <li><a href="./help.html">Help</a></li>
      <li><a href="./contact.html">Contact</a></li>
      <li><a href="./privacy.html">Privacy Policy</a></li>
      <li><a href="./terms.html">Terms of Service</a></li>
      <li><a href="./reviews.html">Reviews</a></li>
    </ul>
  </div>
  <img src="Logo1.jpg" class="footpic" alt="Sponsor Sorter Logo" />
  <div style="margin-top:18px;font-size:0.98em;color:#bbb;">&copy; 2025 Sponsor Sorter. All rights reserved.</div>
</footer>

<script type="module">
import { supabase } from './js/supabaseClient.js';
import { notifyOfferUpdate } from './js/alerts.js';

async function createGroupOfferFromSession() {
  const statusDiv = document.getElementById('insert-status');
  const url = new URL(window.location.href);
  const session_id = url.searchParams.get('session_id');
  const payment_status = url.searchParams.get('payment_status');

  // 1) Validate first
  if (!session_id || payment_status !== 'success') {
    statusDiv.innerHTML = `<span style="color:red;">No valid payment found. Please contact support if this is an error.</span>`;
    return;
  }

  // 2) Idempotency check (only with a valid session_id)
  const { data: existing } = await supabase
    .from('group_offers')
    .select('id')
    .eq('stripe_session_id', session_id)
    .limit(1);

  if (existing && existing.length) {
    statusDiv.innerHTML = `<span style="color:green;">Group offer already recorded. Redirecting...</span>`;
    localStorage.removeItem('pendingGroupOfferData');
    setTimeout(() => window.location.href = './dashboardsponsor.html', 1500);
    return;
  }

  if (!session_id || payment_status !== 'success') {
    statusDiv.innerHTML = `<span style="color:red;">No valid payment found. Please contact support if this is an error.</span>`;
    return;
  }

  let offerData = localStorage.getItem('pendingGroupOfferData');
  if (!offerData) {
    statusDiv.innerHTML = `<span style="color:red;">No offer data found. Please resubmit your group offer.</span>`;
    return;
  }
  offerData = JSON.parse(offerData);
  offerData.stripe_session_id = session_id;
  offerData.stripe_payment_status = payment_status;

  // Insert into group_offers
  const { data: insertedOffers, error: insertError } = await supabase
    .from('group_offers')
    .insert([offerData])
    .select('id, group_id, offer_title');

  if (insertError || !insertedOffers || insertedOffers.length === 0) {
    statusDiv.innerHTML = `<span style="color:red;">Group offer creation failed: ${insertError?.message || 'Unknown error.'}</span>`;
    return;
  }

  const inserted = insertedOffers[0];

  // Notify owner/admins of the group (AFTER commit)
  try {
    const { data: admins } = await supabase
      .from('friend_group_members')
      .select('user_id, role')
      .eq('group_id', offerData.group_id);

    const adminIds = (admins || [])
      .filter(m => ['owner','admin'].includes((m.role||'').toLowerCase()))
      .map(m => m.user_id)
      .filter(Boolean);

    for (const to_user_id of adminIds) {
      await notifyOfferUpdate({
        to_user_id,
        offer_id: inserted.id,
        type: 'group_offer_created',
        title: 'New Group Offer',
        message: `A new group offer "${offerData.offer_title}" was submitted to your group.`
      });
    }
  } catch (e) {
    // non-critical
  }

  statusDiv.innerHTML = `<span style="color:green;">Group offer submitted! It will appear in the group's Pending Offers.<br>Redirecting to your dashboard...</span>`;
  localStorage.removeItem('pendingGroupOfferData');
  setTimeout(() => window.location.href = './dashboardsponsor.html', 2400);
}

document.addEventListener('DOMContentLoaded', createGroupOfferFromSession);
</script>

</body>
</html>
