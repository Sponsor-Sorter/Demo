<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Sponsor Sorter Blog & Resource Center ‚Äì tips, guides, case studies for sponsors and creators">
  <title>Blog & Resource Center - Sponsor Sorter</title>

  <link rel="icon" href="./favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="./styles.css">

  <!-- Keep these if you want the logged-in settings dropdown + alerts to work on this page -->
  <script type="module" src="./js/settings.js"></script>
  <script type="module" src="./js/alerts.js"></script>
</head>

<body>
<header class="navbar1">
  <section class="navbar">
    <div class="navii">
      <h5><header>Sponsor Sorter</header></h5>
      <div>
        <background-img class="navimg" src="navimg.png" alt=""></background-img>

        <nav>
          <li><a href="./index.html">Home</a></li>
          <li><a href="./finder.html">Finder</a></li>
        </nav>

        <nav class="nav">
          <li class="navr" id="auth-link"><a href="./signup.html">Signup</a></li>
          <li><a href="./login.html" id="login-logout-link">Login</a></li>

          <!-- Hidden for guests -->
          <li id="settings-notif-bar" style="display:none;">
            <div class="icon-bar-bg">
              <button id="notification-bell" class="notification-bell-btn" style="background:none;border:none;cursor:pointer;position:relative;vertical-align:middle;">
                <img src="bell.png" alt="Notifications" style="width:28px;vertical-align:middle;">
                <span id="notification-count" class="notification-badge" style="position:absolute;top:-6px;right:2px;background:red;color:white;border-radius:50%;font-size:12px;padding:1px 6px;display:none;">0</span>
              </button>

              <button id="settings-cog-btn" class="settings-cog-btn" title="Settings" style="background:none;border:none;cursor:pointer;position:relative;vertical-align:middle;">
                <img src="cog.svg" alt="Settings" style="width:27px;vertical-align:middle;">
              </button>

              <div id="settings-dropdown" class="settings-dropdown">
                <div class="dropdown-arrow"></div>
                <ul>
                  <li><button type="button" class="dropdown-item" id="change-profile-logo-btn">Change Profile Logo</button></li>
                  <li><button type="button" class="dropdown-item" id="edit-profile-description-btn">Edit Profile Description</button></li>
                  <li><button type="button" class="dropdown-item" id="relink-social-btn">Relink Social Media Handles</button></li>
                  <li><button type="button" class="dropdown-item" id="toggle-help-blocks-btn">Hide/Show All Help Blocks</button></li>
                  <li><button type="button" class="dropdown-item" id="toggle-onboarding-btn">Show Guided Onboarding</button></li>
                </ul>
              </div>
            </div>
          </li>
        </nav>

      </div>
    </div>
  </section>
</header>

<section>
  <div class="blog-hero">
    <h1>üìö Blog & Resource Center</h1>
    <p>Actionable tips, guides, and platform updates for both creators and sponsors. Discover our latest resources, stories, and news.</p>
  </div>

  <!-- Non-blocking guest banner -->
  <div id="blog-guest-banner" class="blog-guest-banner" style="display:none;"></div>

  <!-- Featured section -->
  <div id="featured-wrap" class="featured-wrap" style="display:none;">
    <h2 class="featured-title">‚≠ê Featured</h2>
    <div id="featured-list" class="featured-list">
      <div class="blog-loading">Loading featured articles...</div>
    </div>
  </div>

  <div class="blog-controls">
    <input type="text" id="blog-search" placeholder="Search articles, guides, authors...">
    <select id="blog-category">
      <option value="">All Categories</option>
      <option value="guides">Guides</option>
      <option value="case_study">Case Studies</option>
      <option value="platform">Platform News</option>
      <option value="tips">Tips</option>
      <option value="analytics">Analytics</option>
    </select>
    <button id="blog-add-btn" style="display:none;">‚ûï New Article</button>
  </div>

  <!-- Main list -->
  <div id="blog-list" class="blog-list">
    <div class="blog-loading">Loading articles...</div>
  </div>
</section>

<!-- Admin Blog Modal -->
<div id="blog-modal-root"></div>

<!-- Guest ‚Äúkeep reading‚Äù gate modal -->
<div id="guest-gate-modal-root"></div>

<!-- FOOTER -->
<footer class="footercomplete">
  <div class="footer-text">
    <ul>
      <li><a href="./help.html">Help</a></li>
      <li><a href="./contact.html">Contact</a></li>
      <li><a href="./privacy.html">Privacy Policy</a></li>
      <li><a href="./terms.html">Terms of Service</a></li>
      <li><a href="./reviews.html">Reviews</a></li>
      <li><a href="./blog.html">Blog</a></li>
      <li><a href="./forum.html">Forum</a></li>
      <li><a href="./stats.html">Stats</a></li>
    </ul>
  </div>
  <img src="Logo1.jpg" class="footpic" alt="Sponsor Sorter Logo">
  <div style="margin-top:18px;font-size:0.98em;color:#bbb;">
    &copy; 2025 Sponsor Sorter. All rights reserved. | ABN: 23 801 694 480 <br>
    Data protected by <a href="https://supabase.com/" target="_blank" style="color:#bbb;text-decoration:underline;">Supabase</a> | Powered by <a href="https://stripe.com/" target="_blank" style="color:#bbb;text-decoration:underline;">Stripe</a>
  </div>
</footer>

<style>
.blog-hero { margin: 40px auto 14px auto; max-width: 760px; text-align: center; }
.blog-hero h1 { color: #36a2eb; margin-bottom: 8px; font-size: 2.3em; }
.blog-hero p { color: #ccc; font-size: 1.12em; font-weight: 400; }

/* Guest banner (non-blocking) */
.blog-guest-banner {
  max-width: 830px;
  margin: 10px auto 18px auto;
  padding: 14px 16px;
  border-radius: 12px;
  background: #23232b;
  border: 1.5px solid #323247;
  color: #f8f8ff;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}
.blog-guest-banner .left { display:flex; flex-direction:column; gap:4px; }
.blog-guest-banner .left strong { color:#36a2eb; }
.blog-guest-banner .actions { display:flex; gap:10px; flex-wrap:wrap; }
.blog-guest-banner .btn-primary,
.blog-guest-banner .btn-secondary {
  display: inline-block; padding: 8px 14px; border-radius: 8px;
  font-weight: 800; text-decoration: none;
}
.blog-guest-banner .btn-primary { background: #f6c62e; color: #222; }
.blog-guest-banner .btn-secondary { background: #23232b; color: #fff; border: 1px solid #3a3a4e; }

/* Featured */
.featured-wrap { max-width: 1200px; margin: 6px auto 18px auto; padding: 0 12px; }
.featured-title { color: #f6c62e; margin: 0 0 8px 4px; font-size: 1.35em; font-weight: 800; letter-spacing: .3px; }
.featured-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(295px, 1fr)); gap: 18px; }

.blog-controls {
  display: flex; gap: 16px; max-width: 830px;
  margin: 0 auto 22px auto; align-items: center; justify-content: center;
}
#blog-search {
  flex: 2; padding: 8px 13px; border-radius: 7px; border: none;
  background: #23232b; color: #f8f8ff; font-size: 1em; outline: none;
}
#blog-category {
  flex: 1; padding: 8px 13px; border-radius: 7px; border: none;
  background: #23232b; color: #36a2eb; font-size: 1em;
}
#blog-add-btn {
  padding: 7px 19px; border-radius: 7px; background: #f6c62e; color: #23232b;
  font-weight:700; border:none; cursor:pointer;
}

.blog-list {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(295px, 1fr));
  gap: 22px; max-width: 1200px; margin: 0 auto 48px auto; padding: 0 12px;
}
.blog-loading { grid-column: 1/-1; color: #aaa; text-align: center; margin: 40px 0; font-size: 1.15em; }

.blog-card {
  background: #23232b;
  border-radius: 14px;
  box-shadow: 0 2px 16px #0002;
  padding: 0 0 18px 0;
  display: flex;
  flex-direction: column;
  min-height: 280px;
  transition: transform .12s cubic-bezier(.9,0,.3,1);
  border: 1.5px solid #323247;
  position: relative;
}
.blog-card:hover { transform: translateY(-4px) scale(1.018); border-color: #36a2eb; }

.blog-img { width: 100%; height: 158px; object-fit: cover; border-radius: 14px 14px 0 0; background: #151522; }
.blog-meta { padding: 13px 18px 0 18px; color: #bbb; font-size: 0.96em; display: flex; flex-wrap: wrap; align-items: center; gap: 10px 16px; margin-bottom: 4px; }
.blog-author-img { width:33px; height:33px; border-radius:50%; object-fit:cover; margin-right:7px; background:#292941;}
.blog-title { padding: 0 18px; font-size: 1.18em; font-weight: 700; margin: 10px 0 6px 0; color: #f6c62e; }
.blog-excerpt { color: #f8f8ff; margin: 0 0 10px 0; font-size: 1.07em; line-height: 1.6; padding: 0 18px; }
.blog-tags { display: flex; flex-wrap: wrap; gap: 6px; margin: 4px 0 0 0; padding: 0 18px; }
.blog-tag { background: #36a2eb33; color: #36a2eb; font-size: 0.85em; border-radius: 8px; padding: 2.5px 9px; font-weight: 500; }
.blog-link { display: inline-block; margin: 12px 0 0 18px; color: #36a2eb; font-weight: 600; font-size: 1em; text-decoration: none; }
.blog-link:hover { text-decoration: underline; }

.featured-badge {
  position: absolute; top: 10px; left: -6px; background: #f6c62e; color: #222;
  padding: 4px 10px; font-weight: 800; border-radius: 0 8px 8px 0; box-shadow: 0 2px 10px #0006; font-size: .82em;
}

/* Admin modal */
#blog-modal-root { position:fixed; left:0; top:0; width:100vw; height:100vh; z-index:9000; display:none; }
#blog-modal-root.active { display:block; }
.blog-modal-backdrop { position:absolute; left:0; top:0; width:100vw; height:100vh; background:#000c; }
.blog-modal {
  position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%);
  background: #222436; border-radius: 12px; max-width: 480px; width: 97vw;
  padding: 34px 26px 22px 26px; box-shadow: 0 7px 40px #0009;
  color: #f8f8ff;
}
.blog-modal h2 { color:#36a2eb; margin:0 0 18px 0; }
.blog-modal label { display:block; margin:10px 0 3px 0; color:#ccc; }
.blog-modal input, .blog-modal textarea, .blog-modal select {
  width:100%; margin-bottom:14px; padding:8px 10px; border-radius:7px;
  border:none; background:#23232b; color:#f8f8ff; font-size:1em;
}
.blog-modal textarea { min-height:120px; }
.blog-modal-btns { display:flex; justify-content: flex-end; gap:10px; margin-top:10px;}
.blog-modal-btns button { padding:7px 17px; border-radius:7px; border:none; font-weight:600; cursor:pointer;}
.blog-modal-cancel { background:#23232b; color:#fff;}
.blog-modal-save { background:#f6c62e; color:#222; }

/* Guest gate modal */
#guest-gate-modal-root { position:fixed; inset:0; z-index:9200; display:none; }
#guest-gate-modal-root.active { display:block; }
.gate-backdrop { position:absolute; inset:0; background:#000c; }
.gate-modal {
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  width: min(520px, 95vw);
  background:#222436;
  border: 1.5px solid #323247;
  border-radius: 14px;
  box-shadow: 0 10px 60px #000b;
  padding: 22px 18px;
  color:#f8f8ff;
}
.gate-top { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
.gate-title { margin:0; color:#36a2eb; font-size:1.15em; }
.gate-close {
  background: transparent; border:none; color:#fff; cursor:pointer;
  font-size: 18px; line-height: 1; padding: 6px 8px; border-radius: 8px;
}
.gate-close:hover { background:#23232b; }
.gate-actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
.gate-actions a {
  display:inline-block; padding: 9px 14px; border-radius: 10px;
  text-decoration:none; font-weight: 900;
}
.gate-actions .primary { background:#f6c62e; color:#222; }
.gate-actions .secondary { background:#23232b; color:#fff; border:1px solid #3a3a4e; }

@media (max-width: 950px) {
  .blog-list { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
  .blog-hero { padding: 0 8px; }
}
@media (max-width: 600px) {
  .blog-list { grid-template-columns: 1fr; }
  .blog-hero h1 { font-size: 1.3em;}
  .blog-controls { flex-direction: column; gap: 10px; }
  .blog-guest-banner { flex-direction: column; align-items: flex-start; }
}
</style>

<script type="module">
import { supabase } from './js/supabaseClient.js';

let allPosts = [];
let userIsAdmin = false;
let userProfile = null;
let currentSessionUser = null;

async function updateNavForSession(session) {
  const authLink = document.getElementById('auth-link');
  const loginLogout = document.getElementById('login-logout-link');
  const settingsBar = document.getElementById('settings-notif-bar');

  if (settingsBar) settingsBar.style.display = session?.user ? 'inline' : 'none';

  if (authLink) {
    if (session?.user) {
      let dashboardUrl = './dashboardsponsee.html';
      try {
        const { data: ext } = await supabase
          .from('users_extended_data')
          .select('userType')
          .eq('user_id', session.user.id)
          .maybeSingle();

        const t = (ext?.userType || '').toLowerCase();
        if (t === 'sponsor') dashboardUrl = './dashboardsponsor.html';
        else if (t === 'admin') dashboardUrl = './admindashboard.html';
        else dashboardUrl = './dashboardsponsee.html';
      } catch {}
      authLink.innerHTML = `<a href="${dashboardUrl}">Dashboard</a>`;
    } else {
      authLink.innerHTML = `<a href="./signup.html">Signup</a>`;
    }
  }

  if (loginLogout) {
    loginLogout.onclick = null;

    if (session?.user) {
      loginLogout.textContent = 'Logout';
      loginLogout.href = '#';
      loginLogout.addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          await supabase.auth.signOut();
        } finally {
          location.href = './login.html';
        }
      });
    } else {
      loginLogout.textContent = 'Login';
      loginLogout.href = './login.html';
    }
  }
}

function showGuestBanner() {
  const banner = document.getElementById('blog-guest-banner');
  if (!banner) return;

  banner.style.display = '';
  banner.innerHTML = `
    <div class="left">
      <strong>Reading as a guest</strong>
      <div style="opacity:.9;">Create an account to unlock more tools, offers, and your own dashboard.</div>
    </div>
    <div class="actions">
      <a class="btn-secondary" href="./login.html">Log in</a>
      <a class="btn-primary" href="./signup.html">Create account</a>
    </div>
  `;
}

function hideGuestBanner() {
  const banner = document.getElementById('blog-guest-banner');
  if (!banner) return;
  banner.style.display = 'none';
  banner.innerHTML = '';
}

function openGuestGateModal(intendedUrl = './signup.html') {
  const root = document.getElementById('guest-gate-modal-root');
  if (!root) return;

  const safeUrl = intendedUrl || './signup.html';
  const loginNext = `./login.html?next=${encodeURIComponent(safeUrl)}`;
  const signupNext = `./signup.html?next=${encodeURIComponent(safeUrl)}`;

  root.classList.add('active');
  root.innerHTML = `
    <div class="gate-backdrop" id="gate-backdrop"></div>
    <div class="gate-modal" role="dialog" aria-modal="true" aria-label="Sign up to keep reading">
      <div class="gate-top">
        <div>
          <h3 class="gate-title">Sign up to keep reading</h3>
          <div style="opacity:.92; margin-top:6px; line-height:1.55;">
            This article is available to members. Create an account (or log in) to read the full post.
          </div>
        </div>
        <button class="gate-close" type="button" id="gate-close" aria-label="Close">‚úï</button>
      </div>

      <div class="gate-actions">
        <a class="secondary" href="${loginNext}">Log in</a>
        <a class="primary" href="${signupNext}">Create account</a>
      </div>

      <div style="opacity:.75; font-size:.92em; margin-top:12px;">
        Tip: Members also get access to dashboards, offers, and platform tools.
      </div>
    </div>
  `;

  const close = () => {
    root.classList.remove('active');
    root.innerHTML = '';
  };

  root.querySelector('#gate-close')?.addEventListener('click', close);
  root.querySelector('#gate-backdrop')?.addEventListener('click', close);

  // ESC to close
  document.addEventListener('keydown', function onEsc(e) {
    if (e.key === 'Escape') {
      close();
      document.removeEventListener('keydown', onEsc);
    }
  });
}

async function initAsAuthenticated(sessionUser) {
  currentSessionUser = sessionUser;

  try {
    const { data } = await supabase
      .from('users_extended_data')
      .select('user_id, username, profile_pic, is_admin')
      .eq('user_id', sessionUser.id)
      .single();

    userProfile = data || null;
    userIsAdmin = !!data?.is_admin;

    const addBtn = document.getElementById('blog-add-btn');
    if (addBtn) addBtn.style.display = userIsAdmin ? '' : 'none';
  } catch {
    userProfile = null;
    userIsAdmin = false;
    const addBtn = document.getElementById('blog-add-btn');
    if (addBtn) addBtn.style.display = 'none';
  }

  hideGuestBanner();
  await fetchBlogPosts();
}

async function initAsGuest() {
  currentSessionUser = null;
  userProfile = null;
  userIsAdmin = false;

  const addBtn = document.getElementById('blog-add-btn');
  if (addBtn) addBtn.style.display = 'none';

  showGuestBanner();
  await fetchBlogPosts();
}

async function fetchBlogPosts() {
  const container = document.getElementById('blog-list');
  const featuredWrap = document.getElementById('featured-wrap');
  const featuredList = document.getElementById('featured-list');

  if (container) container.innerHTML = `<div class="blog-loading">Loading articles...</div>`;
  if (featuredList) featuredList.innerHTML = `<div class="blog-loading">Loading featured articles...</div>`;

  const { data, error } = await supabase
    .from('blog_posts')
    .select('*, author:author_id(user_id, username, profile_pic)')
    .eq('published', true)
    .order('created_at', { ascending: false });

  if (error) {
    if (featuredWrap) featuredWrap.style.display = 'none';
    if (container) {
      container.innerHTML = `
        <div class="blog-loading">
          Unable to load blog posts right now.<br><br>
          If you just enabled public access: make sure your Supabase RLS allows <strong>anon SELECT</strong> on <strong>blog_posts</strong>.
        </div>
      `;
    }
    allPosts = [];
    return;
  }

  allPosts = Array.isArray(data) ? data : [];

  const featured = allPosts.filter(p => !!p.is_featured);
  const nonFeatured = allPosts.filter(p => !p.is_featured);

  renderFeaturedPosts(featured);
  renderBlogPosts(nonFeatured);
}

function renderFeaturedPosts(posts) {
  const wrap = document.getElementById('featured-wrap');
  const container = document.getElementById('featured-list');
  if (!wrap || !container) return;

  if (!posts.length) {
    wrap.style.display = 'none';
    container.innerHTML = '';
    return;
  }
  wrap.style.display = '';

  container.innerHTML = posts.map(post => {
    const authorImg = post.author?.profile_pic
      ? `https://mqixtrnhotqqybaghgny.supabase.co/storage/v1/object/public/logos/${post.author.profile_pic}`
      : './logos.png';

    const authorName = post.author?.username || post.author_name || 'Sponsor Sorter Team';
    const url = `./blog-article.html?id=${encodeURIComponent(post.id)}`;

    return `
      <div class="blog-card">
        <div class="featured-badge">FEATURED</div>
        ${post.cover_image ? `
          <img src="${post.cover_image}" alt="" class="blog-img" loading="lazy"
               onerror="handleImgError(event, './logos.png')">` : ''
        }
        <div class="blog-meta">
          <img src="${authorImg}" class="blog-author-img" title="${escapeHtml(authorName)}"
               onerror="handleImgError(event, './logos.png')">
          <span>${escapeHtml(authorName)}</span>
          <span>üóìÔ∏è ${formatDate(post.created_at)}</span>
          <span>üìÇ ${escapeHtml(post.category || 'General')}</span>
        </div>
        <div class="blog-title">${escapeHtml(post.title)}</div>
        <div class="blog-excerpt">${escapeHtml(post.excerpt || truncate(post.content, 160))}</div>
        <div class="blog-tags">
          ${(post.tags || []).map(tag => `<span class="blog-tag">${escapeHtml(tag)}</span>`).join('')}
        </div>
        <a href="${url}" data-url="${url}" class="blog-link read-more-link">Read More &rarr;</a>
        ${userIsAdmin ? `<div style="text-align:right;padding-right:14px;">
          <button class="blog-edit-btn" data-id="${post.id}" style="margin-top:4px;">Edit</button>
        </div>` : ''}
      </div>
    `;
  }).join('');

  if (userIsAdmin) {
    document.querySelectorAll('.blog-edit-btn').forEach(btn => {
      btn.onclick = () => openBlogModal(btn.getAttribute('data-id'));
    });
  }
}

function renderBlogPosts(posts) {
  const container = document.getElementById('blog-list');
  if (!container) return;

  if (!posts.length) {
    container.innerHTML = `<div class="blog-loading">No articles found. Check back soon!</div>`;
    return;
  }

  container.innerHTML = posts.map(post => {
    const authorImg = post.author?.profile_pic
      ? `https://mqixtrnhotqqybaghgny.supabase.co/storage/v1/object/public/logos/${post.author.profile_pic}`
      : './logos.png';

    const authorName = post.author?.username || post.author_name || 'Sponsor Sorter Team';
    const url = `./blog-article.html?id=${encodeURIComponent(post.id)}`;

    return `
      <div class="blog-card">
        ${post.cover_image ? `
          <img src="${post.cover_image}" alt="" class="blog-img" loading="lazy"
               onerror="handleImgError(event, './logos.png')">` : ''
        }
        <div class="blog-meta">
          <img src="${authorImg}" class="blog-author-img" title="${escapeHtml(authorName)}"
               onerror="handleImgError(event, './logos.png')">
          <span>${escapeHtml(authorName)}</span>
          <span>üóìÔ∏è ${formatDate(post.created_at)}</span>
          <span>üìÇ ${escapeHtml(post.category || 'General')}</span>
        </div>
        <div class="blog-title">${escapeHtml(post.title)}</div>
        <div class="blog-excerpt">${escapeHtml(post.excerpt || truncate(post.content, 160))}</div>
        <div class="blog-tags">
          ${(post.tags || []).map(tag => `<span class="blog-tag">${escapeHtml(tag)}</span>`).join('')}
        </div>
        <a href="${url}" data-url="${url}" class="blog-link read-more-link">Read More &rarr;</a>
        ${userIsAdmin ? `<div style="text-align:right;padding-right:14px;">
          <button class="blog-edit-btn" data-id="${post.id}" style="margin-top:4px;">Edit</button>
        </div>` : ''}
      </div>
    `;
  }).join('');

  if (userIsAdmin) {
    document.querySelectorAll('.blog-edit-btn').forEach(btn => {
      btn.onclick = () => openBlogModal(btn.getAttribute('data-id'));
    });
  }
}

async function openBlogModal(editId = null) {
  if (!userIsAdmin) return;

  const root = document.getElementById('blog-modal-root');
  const editing = !!editId;

  let data = {
    title: '', content: '', excerpt: '', tags: '', category: 'general',
    published: false, cover_image: '', is_featured: false
  };

  if (editing) {
    const { data: posts } = await supabase.from('blog_posts').select('*').eq('id', editId).limit(1);
    if (posts && posts.length) data = posts[0];
  }

  root.classList.add('active');
  root.innerHTML = `
    <div class="blog-modal-backdrop" onclick="document.getElementById('blog-modal-root').classList.remove('active');document.getElementById('blog-modal-root').innerHTML=''"></div>
    <div class="blog-modal">
      <h2>${editing ? 'Edit Article' : 'New Article'}</h2>
      <form id="blog-edit-form">
        <label>Title</label>
        <input name="title" value="${escapeHtml(data.title)}" required maxlength="140">

        <label>Excerpt</label>
        <input name="excerpt" value="${escapeHtml(data.excerpt || '')}" maxlength="200">

        <label>Content (Markdown/HTML)</label>
        <textarea name="content" required>${escapeHtml(data.content || '')}</textarea>

        <label>Tags (comma separated)</label>
        <input name="tags" value="${(Array.isArray(data.tags) ? data.tags.join(', ') : '')}">

        <label>Category</label>
        <select name="category">
          <option value="guides" ${data.category==="guides"?"selected":""}>Guides</option>
          <option value="case_study" ${data.category==="case_study"?"selected":""}>Case Study</option>
          <option value="platform" ${data.category==="platform"?"selected":""}>Platform News</option>
          <option value="tips" ${data.category==="tips"?"selected":""}>Tips</option>
          <option value="analytics" ${data.category==="analytics"?"selected":""}>Analytics</option>
          <option value="general" ${!data.category||data.category==="general"?"selected":""}>General</option>
        </select>

        <label>Cover Image URL</label>
        <input name="cover_image" value="${escapeHtml(data.cover_image||'')}">

        <label>Featured?</label>
        <select name="is_featured">
          <option value="false">No</option>
          <option value="true" ${data.is_featured?"selected":""}>Yes</option>
        </select>

        <label>Publish?</label>
        <select name="published">
          <option value="false">No</option>
          <option value="true" ${data.published?"selected":""}>Yes</option>
        </select>

        <div class="blog-modal-btns">
          <button type="button" class="blog-modal-cancel" onclick="document.getElementById('blog-modal-root').classList.remove('active');document.getElementById('blog-modal-root').innerHTML=''">Cancel</button>
          <button type="submit" class="blog-modal-save">${editing ? 'Save' : 'Publish'}</button>
        </div>
      </form>
    </div>
  `;

  document.getElementById('blog-edit-form').onsubmit = async function(e) {
    e.preventDefault();

    const form = e.target;
    const values = {
      title: form.title.value.trim(),
      excerpt: form.excerpt.value.trim(),
      content: form.content.value.trim(),
      tags: form.tags.value.split(',').map(x => x.trim()).filter(Boolean),
      category: form.category.value,
      cover_image: form.cover_image.value.trim(),
      is_featured: form.is_featured.value === "true",
      published: form.published.value === "true"
    };

    if (userProfile) {
      values.author_id = userProfile.user_id;
      values.author_name = userProfile.username;
      values.author_image = userProfile.profile_pic || '';
    }

    if (editing) {
      await supabase.from('blog_posts').update(values).eq('id', editId);
    } else {
      await supabase.from('blog_posts').insert([values]);
    }

    document.getElementById('blog-modal-root').classList.remove('active');
    document.getElementById('blog-modal-root').innerHTML = '';
    await fetchBlogPosts();
  };
}

function wireFilters() {
  const search = document.getElementById('blog-search');
  const cat = document.getElementById('blog-category');
  const addBtn = document.getElementById('blog-add-btn');

  if (search) search.addEventListener('input', filterPosts);
  if (cat) cat.addEventListener('change', filterPosts);
  if (addBtn) addBtn.addEventListener('click', () => openBlogModal());
}

function filterPosts() {
  const searchVal = (document.getElementById('blog-search')?.value || '').toLowerCase();
  const catVal = (document.getElementById('blog-category')?.value || '').toLowerCase();

  const filtered = allPosts.filter(post => {
    const inCat = !catVal || (post.category && post.category.toLowerCase() === catVal);
    const inSearch = !searchVal ||
      (post.title && post.title.toLowerCase().includes(searchVal)) ||
      (post.content && post.content.toLowerCase().includes(searchVal)) ||
      (post.author?.username && post.author.username.toLowerCase().includes(searchVal)) ||
      (post.author_name && post.author_name.toLowerCase().includes(searchVal)) ||
      (Array.isArray(post.tags) && post.tags.join(' ').toLowerCase().includes(searchVal));
    return inCat && inSearch;
  });

  const featured = filtered.filter(p => !!p.is_featured);
  const nonFeatured = filtered.filter(p => !p.is_featured);

  renderFeaturedPosts(featured);
  renderBlogPosts(nonFeatured);
}

function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/[&<>"']/g, c => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[c]));
}

function formatDate(dt) {
  if (!dt) return '';
  const date = new Date(dt);
  return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
}

function truncate(str, n) {
  if (!str) return '';
  return str.length > n ? str.slice(0, n) + '‚Ä¶' : str;
}

window.handleImgError = function(event, fallback = './logos.png') {
  if (!event?.target?.src) return;
  if (!event.target.src.endsWith(fallback)) event.target.src = fallback;
};

// Gate anon users when they click "Read More"
document.addEventListener('click', (e) => {
  const link = e.target?.closest?.('a.read-more-link');
  if (!link) return;

  if (!currentSessionUser) {
    e.preventDefault();
    const intended = link.getAttribute('data-url') || link.getAttribute('href') || './signup.html';
    openGuestGateModal(intended);
  }
});

// --- Page bootstrap ---
document.addEventListener('DOMContentLoaded', async () => {
  wireFilters();

  const { data: { session } } = await supabase.auth.getSession();
  await updateNavForSession(session);

  if (session?.user) {
    await initAsAuthenticated(session.user);
  } else {
    await initAsGuest();
  }

  // React to auth changes live
  supabase.auth.onAuthStateChange(async (_event, sess) => {
    await updateNavForSession(sess);
    if (sess?.user) await initAsAuthenticated(sess.user);
    else await initAsGuest();
  });
});
</script>

</body>
</html>

